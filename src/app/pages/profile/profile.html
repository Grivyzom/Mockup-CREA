<section class="profile-wrap no-select">
  <div class="container">
    <!-- Información personal -->
    <div class="card dark">
      <div class="card-header">
        <div>
          <h2 class="section-title">Información personal</h2>
          <p class="section-desc">Utilice una dirección permanente donde pueda recibir correo.</p>
        </div>
        <div class="avatar-col">
          <img class="avatar" [src]="profile.avatarUrl || 'public/favicon.ico'" alt="Avatar"/>
          <div class="avatar-actions">
            <label class="btn-inacap-secondary small" for="avatarInput">
              Cambiar avatar
            </label>
            <input id="avatarInput" type="file" accept="image/png,image/jpeg,image/gif" (change)="onAvatarSelected($event)" hidden />
          </div>
          <small class="avatar-hint">JPG, GIF o PNG. 1 MB máximo.</small>
          @if (avatarLoading) {<div class="status-loading">Cargando imagen…</div>}
          @if (avatarSuccess) {<div class="status-success">Avatar actualizado</div>}
          @if (avatarError) {<div class="status-error">{{ avatarError }}</div>}
        </div>
      </div>

      <form [formGroup]="form" (ngSubmit)="saveProfile()" novalidate>
        <div class="grid-2">
          <div class="field">
            <label for="firstName">Nombre de pila</label>
            <input id="firstName" type="text" formControlName="firstName" autocomplete="given-name" [readonly]="!isEditingProfile"/>
            @if ((form.get('firstName')?.touched || submittedProfile) && form.get('firstName')?.invalid) {<div class="msg">Requerido</div>}
          </div>
          <div class="field">
            <label for="lastName">Apellido</label>
            <input id="lastName" type="text" formControlName="lastName" autocomplete="family-name" [readonly]="!isEditingProfile"/>
            @if ((form.get('lastName')?.touched || submittedProfile) && form.get('lastName')?.invalid) {<div class="msg">Requerido</div>}
          </div>
        </div>

        <div class="grid-1">
          <div class="field">
            <label for="institutionalEmail">Dirección de correo electrónico</label>
            <input id="institutionalEmail" type="email" formControlName="institutionalEmail" autocomplete="email" [readonly]="!isEditingProfile"/>
            @if ((form.get('institutionalEmail')?.touched || submittedProfile) && form.get('institutionalEmail')?.invalid) {<div class="msg">Correo válido requerido</div>}
          </div>
        </div>

        <div class="grid-1">
          <div class="field">
            <label for="username">Nombre de usuario</label>
            <input id="username" type="text" formControlName="username" autocomplete="username" placeholder="ejemplo.com/ Jane Smith" [readonly]="!isEditingProfile"/>
            @if ((form.get('username')?.touched || submittedProfile) && form.get('username')?.invalid) {<div class="field-error">Mínimo 3 caracteres</div>}
          </div>
        </div>

        <div class="grid-1">
          <div class="field">
            <label for="timezone">Zona horaria</label>
            <select id="timezone" formControlName="timezone" [disabled]="!isEditingProfile">
              <option value="America/Los_Angeles">Hora estándar del Pacífico</option>
              <option value="America/Santiago">Hora de Chile (America/Santiago)</option>
              <option value="America/Argentina/Buenos_Aires">Buenos Aires</option>
              <option value="America/Lima">Lima</option>
              <option value="America/Bogota">Bogotá</option>
              <option value="UTC">UTC</option>
            </select>
          </div>
        </div>

        <div class="actions">
          @if (!isEditingProfile) {
            <button type="button" class="btn-inacap-secondary" (click)="startEditProfile()">Editar</button>
          }
          @if (isEditingProfile) {
            <button class="btn-inacap-primary" type="submit" [disabled]="!canSaveProfile">
              @if (!saving) {<span>Guardar</span>}
              @if (saving) {<span class="btn-loading" aria-label="Guardando"></span>}
            </button>
            <button type="button" class="btn-inacap-secondary" (click)="cancelEditProfile()" [disabled]="saving">Cancelar</button>
          }
          @if (saveSuccess) {<span class="status-success">Guardado</span>}
        </div>
      </form>
    </div>

    <!-- Cambiar contraseña -->
    <div class="card dark">
      <h2 class="section-title">
        <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
        Cambiar la contraseña
      </h2>
      <p class="section-desc">Actualice su contraseña asociada a su cuenta.</p>
      <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" novalidate>
        <div class="password-form-grid">
          <div class="field">
            <label for="current">Contraseña actual</label>
            <div class="input-with-btn">
              <input id="current" [type]="showCurrent ? 'text' : 'password'" formControlName="current" autocomplete="current-password"/>
              <button type="button" class="icon-btn" (click)="showCurrent=!showCurrent" [attr.aria-pressed]="showCurrent" [attr.aria-label]="showCurrent ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                @if (!showCurrent) {
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 616 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                }
                @if (showCurrent) {
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
                  </svg>
                }
              </button>
            </div>
            <small class="hint">Usa 10+ caracteres, mezcla mayúsculas, minúsculas y símbolos.</small>
            @if ((passwordForm.get('current')?.touched || submittedPass) && passwordForm.get('current')?.invalid) {<div class="msg">Requerido</div>}
          </div>
          <div class="field">
            <label for="newPass">Nueva contraseña</label>
            <div class="input-with-btn">
              <input id="newPass" [type]="showNew ? 'text' : 'password'" formControlName="newPass" autocomplete="new-password"/>
              <button type="button" class="icon-btn" (click)="showNew=!showNew" [attr.aria-pressed]="showNew" [attr.aria-label]="showNew ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                @if (!showNew) {
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 616 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                }
                @if (showNew) {
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 711.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
                  </svg>
                }
              </button>
            </div>
            <div class="strength" role="progressbar" [attr.aria-valuenow]="passwordStrength" aria-valuemin="0" aria-valuemax="4" [attr.aria-label]="'Fuerza: ' + strengthLabel">
              <span [class.on]="passwordStrength>0"></span>
              <span [class.on]="passwordStrength>1"></span>
              <span [class.on]="passwordStrength>2"></span>
              <span [class.on]="passwordStrength>3"></span>
            </div>
            <div class="strength-label">{{ strengthLabel }}</div>
            @if ((passwordForm.get('newPass')?.touched || submittedPass) && passwordForm.get('newPass')?.invalid) {<div class="msg">Mínimo 6 caracteres</div>}
          </div>
          <div class="field">
            <label for="confirm">Confirmar contraseña</label>
            <div class="input-with-btn">
              <input id="confirm" [type]="showConfirm ? 'text' : 'password'" formControlName="confirm" autocomplete="new-password"/>
              <button type="button" class="icon-btn" (click)="showConfirm=!showConfirm" [attr.aria-pressed]="showConfirm" [attr.aria-label]="showConfirm ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                @if (!showConfirm) {
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 616 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                }
                @if (showConfirm) {
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 711.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
                  </svg>
                }
              </button>
            </div>
            @if (passMismatch) {<div class="msg">Las contraseñas no coinciden</div>}
          </div>
        </div>
        <div class="actions">
          <button class="btn-inacap-primary" type="submit" [disabled]="passLoading || passwordForm.invalid || passMismatch">
            Ahorrar
          </button>
          @if (passSuccess) {<span class="status-success">Contraseña actualizada</span>}
          @if (passError) {<span class="status-error">{{ passError }}</span>}
        </div>
      </form>
    </div>

    <!-- Autenticación de dos factores (2FA) completa -->
    <div class="card dark">
      <h2 class="section-title">
        <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
        Autenticación de dos factores (2FA)
      </h2>
      <p class="section-desc">Añade una capa adicional de seguridad a tu cuenta utilizando una aplicación de autenticación (Google Authenticator, Authy, etc.).</p>

      <!-- Región accesible para mensajes dinámicos -->
      <div class="sr-only" aria-live="polite">{{ twoFactorSuccess || twoFactorError }}</div>

      <!-- Estado general cuando NO está habilitado y no se está configurando -->
      @if (!twoFactorEnabled && !showSetup) {
        <div class="two-factor-status disabled">
          <div class="status-indicator">
            <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </div>
          <div class="status-content">
            <h3 class="status-title">2FA desactivada</h3>
            <p class="status-desc">Tu cuenta sólo depende de la contraseña. Te recomendamos activarla.</p>
            <div class="two-factor-actions">
              <button type="button" class="btn-inacap-primary" (click)="startTwoFactorSetup()" [disabled]="twoFactorLoading">Activar 2FA</button>
            </div>
          </div>
        </div>
      }

      <!-- Wizard de configuración -->
      @if (showSetup) {
        <div class="two-factor-setup">
          <div class="setup-steps">
            <div class="step" [ngClass]="{active: setupStep===1, completed: setupStep>1}">
              <div class="step-number">1</div>
              <div class="step-content"><div class="step-title">Configura</div></div>
            </div>
            <div class="step" [ngClass]="{active: setupStep===2, completed: setupStep>2}">
              <div class="step-number">2</div>
              <div class="step-content"><div class="step-title">Verifica</div></div>
            </div>
            <div class="step" [ngClass]="{active: setupStep===3}">
              <div class="step-number">3</div>
              <div class="step-content"><div class="step-title">Respaldo</div></div>
            </div>
          </div>

          <!-- Paso 1: Mostrar QR y clave secreta -->
          @if (setupStep === 1) {
            <div class="setup-step">
              <h3 class="step-heading">Escanea el código QR</h3>
              <p class="step-desc">Abre tu app de autenticación y escanea este código. Si no puedes escanearlo, ingresa la clave manualmente.</p>
              <div class="qr-wrapper" aria-label="Código QR para configurar 2FA">
                <img [src]="qrCodeDataUrl" alt="QR 2FA" />
              </div>
              <div class="secret-key">
                <code>{{ twoFactorSecret }}</code>
                <button type="button" class="btn-inacap-secondary small" (click)="copySecret()">Copiar</button>
              </div>
              <div class="wizard-actions">
                <button type="button" class="btn-inacap-primary" (click)="setupStep=2">He escaneado el código</button>
                <button type="button" class="btn-inacap-secondary" (click)="cancelTwoFactorSetup()" [disabled]="twoFactorLoading">Cancelar</button>
              </div>
            </div>
          }

          <!-- Paso 2: Verificación del código -->
          @if (setupStep === 2) {
            <div class="setup-step">
              <h3 class="step-heading">Verifica el código</h3>
              <p class="step-desc">Introduce el código de 6 dígitos que muestra tu aplicación.</p>
              <form [formGroup]="twoFactorForm" (ngSubmit)="completeTwoFactorSetup()" novalidate class="verify-form">
                <div class="field code-field">
                  <label for="verificationCode">Código de verificación</label>
                  <input id="verificationCode" type="text" formControlName="verificationCode" inputmode="numeric" autocomplete="one-time-code" placeholder="000000" maxlength="6" [class.invalid]="submittedTwoFactor && twoFactorForm.invalid"/>
                  @if (submittedTwoFactor && twoFactorForm.get('verificationCode')?.invalid) {<div class="msg">Ingresa un código válido de 6 dígitos</div>}
                </div>
                <div class="wizard-actions">
                  <button type="submit" class="btn-inacap-primary" [disabled]="twoFactorLoading || twoFactorForm.invalid">Verificar</button>
                  <button type="button" class="btn-inacap-secondary" (click)="setupStep=1" [disabled]="twoFactorLoading">Volver</button>
                  <button type="button" class="btn-inacap-secondary" (click)="cancelTwoFactorSetup()" [disabled]="twoFactorLoading">Cancelar</button>
                </div>
              </form>
              @if (twoFactorLoading) {<div class="status-loading">Verificando…</div>}
              @if (twoFactorError) {<div class="status-error">{{ twoFactorError }}</div>}
            </div>
          }

          <!-- Paso 3: Códigos de respaldo -->
          @if (setupStep === 3 && twoFactorEnabled) {
            <div class="setup-step">
              <h3 class="step-heading">Códigos de respaldo</h3>
              <p class="step-desc">Guarda estos códigos en un lugar seguro. Cada uno puede usarse una sola vez si pierdes acceso a tu app 2FA.</p>
              <div class="backup-codes-grid" *ngIf="backupCodes.length"> <!-- fallback para estilos existentes -->
                @for (c of backupCodes; track c.id) {
                  <div class="backup-code" [ngClass]="{used: c.used}">
                    <span class="code-value">{{ c.code }}</span>
                    <span class="code-status">{{ c.used ? 'Usado' : 'Nuevo' }}</span>
                  </div>
                }
              </div>
              <div class="backup-codes-actions">
                <button type="button" class="btn-inacap-secondary" (click)="downloadBackupCodes()">Descargar</button>
                <button type="button" class="btn-inacap-secondary" (click)="regenerateBackupCodes()">Regenerar</button>
                <button type="button" class="btn-inacap-primary" (click)="showSetup=false; setupStep=1; showBackupCodes=true">Finalizar</button>
              </div>
            </div>
          }
        </div>
      }

      <!-- Estado cuando está habilitado -->
      @if (twoFactorEnabled && !showSetup) {
        <div class="two-factor-status enabled">
          <div class="status-indicator">
            <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <div class="status-content">
            <h3 class="status-title">2FA activada</h3>
            <p class="status-desc">Tu cuenta está protegida con un segundo factor.</p>
            <div class="two-factor-actions">
              <button type="button" class="btn-inacap-secondary" (click)="showSetup=true; setupStep=3" *ngIf="!showBackupCodes">Ver códigos de respaldo</button>
              <button type="button" class="btn-danger-inacap" (click)="disableTwoFactor()" [disabled]="twoFactorLoading">Desactivar</button>
            </div>
            @if (twoFactorLoading) {<div class="status-loading">Procesando…</div>}
            @if (twoFactorSuccess) {<div class="status-success">{{ twoFactorSuccess }}</div>}
          </div>
        </div>
      }

      <!-- Mostrar códigos fuera del wizard si el usuario los solicita tras la activación -->
      @if (twoFactorEnabled && showBackupCodes) {
        <div class="backup-codes-section">
          <div class="backup-codes-title">Códigos de respaldo</div>
          <p class="backup-codes-desc">Cada código puede usarse una sola vez. Regenera para invalidar los anteriores.</p>
          <div class="backup-codes-grid">
            @for (c of backupCodes; track c.id) {
              <div class="backup-code" [ngClass]="{used: c.used}">
                <span class="code-value">{{ c.code }}</span>
                <span class="code-status">{{ c.used ? 'Usado' : 'Nuevo' }}</span>
              </div>
            }
          </div>
          <div class="backup-codes-actions">
            <button type="button" class="btn-inacap-secondary" (click)="downloadBackupCodes()">Descargar</button>
            <button type="button" class="btn-inacap-secondary" (click)="regenerateBackupCodes()">Regenerar</button>
            <button type="button" class="btn-inacap-secondary" (click)="showBackupCodes=false">Ocultar</button>
          </div>
        </div>
      }

      @if (twoFactorSuccess && !showSetup) {<div class="status-success mt-2">{{ twoFactorSuccess }}</div>}
      @if (twoFactorError && !showSetup) {<div class="status-error mt-2">{{ twoFactorError }}</div>}
    </div>

    <!-- Cerrar otras sesiones -->
    <div class="card dark">
      <h2 class="section-title">
        <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
        </svg>
        Cerrar otras sesiones
      </h2>
      <p class="section-desc">Ingrese su contraseña para confirmar que desea cerrar sesión en sus otras sesiones en todos sus dispositivos.</p>
      <form [formGroup]="sessionsForm" (ngSubmit)="closeOtherSessions()" novalidate>
        <div class="grid-1">
          <div class="field"><label for="sessionPass">Tu contraseña</label><input id="sessionPass" type="password" formControlName="password" autocomplete="current-password"/></div>
        </div>
        <div class="actions">
          <button class="btn-inacap-secondary" type="submit" [disabled]="sessionsLoading || sessionsForm.invalid">
            Cerrar otras sesiones
          </button>
          @if (sessionsSuccess) {<span class="status-success">Listo</span>}
        </div>
      </form>
    </div>

    <!-- Eliminar cuenta -->
    <div class="card danger dark">
      <h2 class="section-title">
        <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/>
        </svg>
        Eliminar cuenta
      </h2>
      <p class="section-desc">¿Ya no quieres usar nuestro servicio? Puedes eliminar tu cuenta aquí. Esta acción es irreversible. Toda la información relacionada con esta cuenta se eliminará permanentemente.</p>
      <form [formGroup]="deleteForm" (ngSubmit)="deleteAccount()" novalidate>
        <div class="grid-1">
          <div class="field">
            <label for="confirmDel">Escribe ELIMINAR para confirmar</label>
            <input id="confirmDel" type="text" formControlName="confirm"/>
            @if (deleteError) {<div class="err">{{ deleteError }}</div>}
          </div>
        </div>
        <div class="actions">
          <button class="btn-danger-inacap" type="submit" [disabled]="deleteLoading || deleteForm.invalid || confirmText.toUpperCase()!=='ELIMINAR'">
            Sí, eliminar mi cuenta
          </button>
        </div>
      </form>
    </div>
  </div>
</section>